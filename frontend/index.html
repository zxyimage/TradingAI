<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sAI分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
        }
        .stock-card {
            margin-bottom: 20px;
        }
        .recommendation-1 {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
        }
        .recommendation-2 {
            background-color: #e8f4d9;
            border-left: 5px solid #5cb85c;
        }
        .recommendation-3 {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
        }
        .recommendation-4 {
            background-color: #f8f9fa;
            border-left: 5px solid #6c757d;
        }
        .recommendation-5 {
            background-color: #f8f9fa;
            border-left: 5px solid #adb5bd;
        }
        .recommendation-6 {
            background-color: #f8d7da;
            border-left: 5px solid #dc3545;
        }
        .ma-relation {
            display: inline-block;
            margin-right: 8px;
            font-size: 0.85rem;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">sAI分析系统</h1>
        
        <div class="alert alert-info mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <span>系统使用FastAPI提供服务。</span>
                <a href="http://localhost:8000/docs" target="_blank" class="btn btn-primary btn-sm">查看API文档</a>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>管理跟踪s</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="stocksList" class="form-label">当前跟踪的s (以逗号分隔)</label>
                            <textarea class="form-control" id="stocksList" rows="3"></textarea>
                        </div>
                        <button id="updateStocks" class="btn btn-primary">更新s列表</button>
                        <div class="mt-2" id="updateMessage"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>s数据查询</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="stockCode" class="form-label">s代码</label>
                            <select class="form-control" id="stockCode">
                                <!-- 动态生成选项 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="dataDays" class="form-label">数据天数</label>
                            <select class="form-control" id="dataDays">
                                <option value="7">7天</option>
                                <option value="14">14天</option>
                                <option value="30" selected>30天</option>
                                <option value="60">60天</option>
                                <option value="90">90天</option>
                            </select>
                        </div>
                        <button id="queryData" class="btn btn-success">查询数据</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 实时推荐s't列表 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>实时推荐st</h5>
                        <button id="refreshRankedStocks" class="btn btn-outline-primary btn-sm">刷新数据</button>
                    </div>
                    <div class="card-body">
                        <div id="rankedStocksInfo" class="mb-3">
                            <p>加载中...</p>
                        </div>
                        <div id="rankedStocksList" class="row"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 已存储s数据一览 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>已存储s数据一览</h5>
                        <button id="refreshStoredData" class="btn btn-outline-primary btn-sm">刷新数据</button>
                    </div>
                    <div class="card-body">
                        <div id="storedDataSummary" class="mb-3">
                            <p>加载中...</p>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>s代码</th>
                                        <th>最新日期</th>
                                        <th>最新收盘价</th>
                                        <th>涨跌幅</th>
                                        <th>最高价</th>
                                        <th>最低价</th>
                                        <th>成交量</th>
                                        <th>记录数量</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="storedDataTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>s价格图表</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="stockChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>AI分析建议</h5>
                    </div>
                    <div class="card-body">
                        <div id="aiAnalysis">
                            <p>请先查询s数据以获取AI分析建议。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- s详细数据模态框 -->
    <div class="modal fade" id="stockDetailModal" tabindex="-1" aria-labelledby="stockDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stockDetailModalLabel">s详细数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div id="stockDetailInfo" class="mb-3">
                        <p>加载中...</p>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <canvas id="detailStockChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped" id="stockDetailTable">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>开盘价</th>
                                    <th>收盘价</th>
                                    <th>最高价</th>
                                    <th>最低价</th>
                                    <th>成交量</th>
                                    <th>成交额</th>
                                    <th>涨跌幅</th>
                                </tr>
                            </thead>
                            <tbody id="stockDetailTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 实时分析模态框 -->
    <div class="modal fade" id="realtimeAnalysisModal" tabindex="-1" aria-labelledby="realtimeAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="realtimeAnalysisModalLabel">实时分析</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div id="realtimeAnalysisContent">
                        <p>加载中...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // API基础URL - 根据你的实际部署情况修改
        const API_BASE_URL = 'http://localhost:8000/api';
        const API_KEY = 'your-secret-api-key'; // 与后端一致的API密钥
        let stockChart = null;

        // 页面加载时获取s列表和存储的数据
        document.addEventListener('DOMContentLoaded', async () => {
            await loadStockNames(); 
            await loadStocksList();
            await loadStoredStocksData();
            await loadRankedStocks();
        });

        // 通用API请求函数
        async function fetchAPI(endpoint, options = {}) {
            // 确保headers存在
            if (!options.headers) {
                options.headers = {};
            }
            
            // 添加API密钥到请求头
            options.headers['X-API-Key'] = API_KEY;
            
            // 发送请求
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            
            // 处理非2xx响应
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `请求失败: ${response.status}`);
            }
            
            return response.json();
        }

        // 加载s列表
        async function loadStocksList() {
            try {
                const data = await fetchAPI('/stocks');
                
                // 更新文本域
                document.getElementById('stocksList').value = data.stocks.join(',');
                
                // 更新下拉菜单
                const stockCodeSelect = document.getElementById('stockCode');
                stockCodeSelect.innerHTML = '';
                
                data.stocks.forEach(stock => {
                    const option = document.createElement('option');
                    option.value = stock;
                    option.textContent = formatStockCodeName(stock);
                    stockCodeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('加载s列表出错:', error);
            }
        }

        // 更新s列表
        document.getElementById('updateStocks').addEventListener('click', async () => {
            const stocksInput = document.getElementById('stocksList').value;
            const stocks = stocksInput.split(',').map(s => s.trim()).filter(s => s);
            
            try {
                const result = await fetchAPI('/stocks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stocks })
                });
                
                document.getElementById('updateMessage').textContent = result.message;
                document.getElementById('updateMessage').className = result.success ? 'text-success' : 'text-danger';
                
                if (result.success) {
                    await loadStocksList();
                }
            } catch (error) {
                console.error('更新s列表出错:', error);
                document.getElementById('updateMessage').textContent = `更新失败: ${error.message}`;
                document.getElementById('updateMessage').className = 'text-danger';
            }
        });

        // 查询s数据
        document.getElementById('queryData').addEventListener('click', async () => {
            const stockCode = document.getElementById('stockCode').value;
            const days = document.getElementById('dataDays').value;
            
            if (!stockCode) {
                alert('请选择s代码');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/stock_data?code=${stockCode}&days=${days}`);
                const result = await response.json();
                
                if (result.success) {
                    displayStockChart(result.data, stockCode);
                    generateAIAnalysis(result.data, stockCode);
                } else {
                    alert(`获取数据失败: ${result.message}`);
                }
            } catch (error) {
                console.error('查询s数据出错:', error);
                alert(`查询出错: ${error.message}`);
            }
        });

        // 加载实时推荐排名的st
        async function loadRankedStocks() {
            try {
                document.getElementById('rankedStocksInfo').innerHTML = '<p>正在加载实时推荐st...</p>';
                document.getElementById('rankedStocksList').innerHTML = '';
                
                const response = await fetch(`${API_BASE_URL}/ranked_stocks`);
                const result = await response.json();
                
                if (result.success && result.stocks) {
                    displayRankedStocks(result.stocks, result.updated_at);
                } else {
                    document.getElementById('rankedStocksInfo').innerHTML = 
                        `<div class="alert alert-warning">获取实时推荐st失败: ${result.message || '未知错误'}</div>`;
                }
            } catch (error) {
                console.error('加载实时推荐st出错:', error);
                document.getElementById('rankedStocksInfo').innerHTML = 
                    `<div class="alert alert-danger">加载实时推荐出错: ${error.message}</div>`;
            }
        }

        // 刷新实时排名
        document.getElementById('refreshRankedStocks').addEventListener('click', loadRankedStocks);

        // 显示排名st列表
        function displayRankedStocks(stocks, updatedAt) {
            // 更新信息区域
            const formattedTime = new Date(updatedAt).toLocaleString();
            document.getElementById('rankedStocksInfo').innerHTML = 
                `<div class="alert alert-info">共 ${stocks.length} 支st，更新时间: ${formattedTime}</div>`;
            
            // 生成卡片
            let cardsHtml = '';
            
            stocks.forEach(stock => {
                // 创建均线关系标签
                let relationsHtml = '';
                if (stock.ma_relations && stock.ma_relations.length > 0) {
                    stock.ma_relations.forEach(relation => {
                        relationsHtml += `<span class="ma-relation">${relation}</span>`;
                    });
                }
                
                // 根据推荐级别设置样式类
                const levelClass = `recommendation-${stock.recommendation_level}`;
                const actionClass = getActionColorClass(stock.recommendation_text);
                
                cardsHtml += `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 ${levelClass}">
                            <div class="card-body">
                                <h5 class="card-title">${formatStockCodeName(stock.code)}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">价格: ${stock.price.toFixed(2)}</h6>
                                <p class="card-text ${actionClass} fw-bold">推荐: ${stock.recommendation_text}</p>
                                <div class="mb-2">
                                    ${relationsHtml}
                                </div>
                                <p class="card-text text-muted small">${stock.closest_ma || ''}</p>
                                <div class="d-flex justify-content-between mt-2">
                                    <button class="btn btn-sm btn-outline-primary view-realtime" data-code="${stock.code}">
                                        查看分析
                                    </button>
                                    <button class="btn btn-sm btn-outline-success view-chart" data-code="${stock.code}">
                                        查看图表
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('rankedStocksList').innerHTML = cardsHtml;
            
            // 添加事件监听器
            document.querySelectorAll('.view-realtime').forEach(button => {
                button.addEventListener('click', () => {
                    const stockCode = button.getAttribute('data-code');
                    openRealtimeAnalysisModal(stockCode);
                });
            });
            
            document.querySelectorAll('.view-chart').forEach(button => {
                button.addEventListener('click', () => {
                    const stockCode = button.getAttribute('data-code');
                    // 设置下拉框选中该s
                    document.getElementById('stockCode').value = stockCode;
                    // 触发查询
                    document.getElementById('queryData').click();
                    // 滚动到图表位置
                    document.querySelector('.card:has(#stockChart)').scrollIntoView({ behavior: 'smooth' });
                });
            });
        }

        // 打开实时分析模态框
        async function openRealtimeAnalysisModal(stockCode) {
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('realtimeAnalysisModal'));
            modal.show();
            
            // 更新标题
            document.getElementById('realtimeAnalysisModalLabel').textContent = `实时分析 - ${stockCode}`;
            
            // 加载中状态
            document.getElementById('realtimeAnalysisContent').innerHTML = '<p class="text-center">加载中...</p>';
            
            try {
                // 获取实时分析
                const response = await fetch(`${API_BASE_URL}/realtime_analysis?code=${stockCode}`);
                const result = await response.json();
                
                if (result.success) {
                    displayRealtimeAnalysis(result.analysis, stockCode);
                } else {
                    document.getElementById('realtimeAnalysisContent').innerHTML = 
                        `<div class="alert alert-warning">${result.message}</div>`;
                }
            } catch (error) {
                console.error('获取实时分析出错:', error);
                document.getElementById('realtimeAnalysisContent').innerHTML = 
                    `<div class="alert alert-danger">获取分析出错: ${error.message}</div>`;
            }
        }

        // 显示实时分析结果
        function displayRealtimeAnalysis(data, stockCode) {
            const { analysis, recommendations, timestamp } = data;
            
            // 根据建议动作设置样式
            let actionClass = 'text-warning';
            if (recommendations.action === 'BUY') {
                actionClass = 'text-success';
            } else if (recommendations.action === 'SELL') {
                actionClass = 'text-danger';
            }
            
            // 格式化建议理由列表
            const reasonsList = recommendations.reasons.map(reason => `<li>${reason}</li>`).join('');
            
            // 格式化时间
            const formattedTime = new Date(timestamp).toLocaleString();
            
            // 构建HTML
            let analysisHtml = `
                <div class="mb-3">
                    <h6>s代码: ${formatStockCodeName(stockCode)}</h6>
                    <p class="text-muted small">更新时间: ${formattedTime}</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>技术指标</h5>
                        <table class="table table-sm">
                            <tr>
                                <td>最新价格</td>
                                <td>${analysis.latest_price.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>5日均线 (MA5)</td>
                                <td>${analysis.ma5 ? analysis.ma5.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>10日均线 (MA10)</td>
                                <td>${analysis.ma10 ? analysis.ma10.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>20日均线 (MA20)</td>
                                <td>${analysis.ma20 ? analysis.ma20.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>30日均线 (MA30)</td>
                                <td>${analysis.ma30 ? analysis.ma30.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>60日均线 (MA60)</td>
                                <td>${analysis.ma60 ? analysis.ma60.toFixed(2) : '无数据'}</td>
                            </tr>
                        </table>
                        
                        <h6>均线差异</h6>
                        <table class="table table-sm">
                            ${analysis.ma5_diff !== undefined ? `
                            <tr>
                                <td>相对MA5</td>
                                <td class="${analysis.ma5_diff >= 0 ? 'text-danger' : 'text-success'}">
                                    ${analysis.ma5_diff >= 0 ? '+' : ''}${analysis.ma5_diff.toFixed(2)}%
                                </td>
                            </tr>` : ''}
                            ${analysis.ma10_diff !== undefined ? `
                            <tr>
                                <td>相对MA10</td>
                                <td class="${analysis.ma10_diff >= 0 ? 'text-danger' : 'text-success'}">
                                    ${analysis.ma10_diff >= 0 ? '+' : ''}${analysis.ma10_diff.toFixed(2)}%
                                </td>
                            </tr>` : ''}
                            ${analysis.ma20_diff !== undefined ? `
                            <tr>
                                <td>相对MA20</td>
                                <td class="${analysis.ma20_diff >= 0 ? 'text-danger' : 'text-success'}">
                                    ${analysis.ma20_diff >= 0 ? '+' : ''}${analysis.ma20_diff.toFixed(2)}%
                                </td>
                            </tr>` : ''}
                            ${analysis.ma30_diff !== undefined ? `
                            <tr>
                                <td>相对MA30</td>
                                <td class="${analysis.ma30_diff >= 0 ? 'text-danger' : 'text-success'}">
                                    ${analysis.ma30_diff >= 0 ? '+' : ''}${analysis.ma30_diff.toFixed(2)}%
                                </td>
                            </tr>` : ''}
                            ${analysis.ma60_diff !== undefined ? `
                            <tr>
                                <td>相对MA60</td>
                                <td class="${analysis.ma60_diff >= 0 ? 'text-danger' : 'text-success'}">
                                    ${analysis.ma60_diff >= 0 ? '+' : ''}${analysis.ma60_diff.toFixed(2)}%
                                </td>
                            </tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>交易建议</h5>
                        <div class="card">
                            <div class="card-body">
                                <h6 class="${actionClass} text-center fw-bold">建议：${getActionText(recommendations.action)}</h6>
                                <p>置信度: <span class="fw-bold">${(recommendations.confidence * 100).toFixed(0)}%</span></p>
                                <p>风险水平: <span class="fw-bold">${getRiskLevelText(recommendations.risk_level)}</span></p>
                                <p>推荐级别: <span class="fw-bold">${getRecommendationLevelText(recommendations.recommendation_level)}</span></p>
                                
                                <h6>建议理由:</h6>
                                <ul>${reasonsList}</ul>
                                
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <p>支撑位: <span class="text-success fw-bold">${recommendations.support_level ? recommendations.support_level.toFixed(2) : '无数据'}</span></p>
                                    </div>
                                    <div class="col-6">
                                        <p>阻力位: <span class="text-danger fw-bold">${recommendations.resistance_level ? recommendations.resistance_level.toFixed(2) : '无数据'}</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 免责声明 -->
                <p class="text-muted mt-3"><small>免责声明：以上分析仅供参考，不构成投资建议。投资有风险，入市需谨慎。</small></p>
            `;
            
            document.getElementById('realtimeAnalysisContent').innerHTML = analysisHtml;
        }

        // 显示s图表
        function displayStockChart(data, stockCode) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            // 整理数据
            const chartData = {
                labels: data.map(item => new Date(item.time).toLocaleDateString()),
                datasets: [
                    {
                        label: `${stockCode} 收盘价`,
                        data: data.map(item => item.close),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: `${stockCode} 最高价`,
                        data: data.map(item => item.high),
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: `${stockCode} 最低价`,
                        data: data.map(item => item.low),
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1,
                        fill: false
                    }
                ]
            };
            
            // 添加移动平均线
            // 计算5日均线
            const ma5Data = calculateMovingAverage(data.map(item => item.close), 5);
            chartData.datasets.push({
                label: `5日均线 (MA5)`,
                data: ma5Data,
                borderColor: 'rgb(255, 159, 64)',
                borderDash: [5, 5],
                tension: 0.1,
                fill: false
            });
            
            // 计算10日均线
            const ma10Data = calculateMovingAverage(data.map(item => item.close), 10);
            chartData.datasets.push({
                label: `10日均线 (MA10)`,
                data: ma10Data,
                borderColor: 'rgb(153, 102, 255)',
                borderDash: [5, 5],
                tension: 0.1,
                fill: false
            });
            
            // 计算20日均线
            const ma20Data = calculateMovingAverage(data.map(item => item.close), 20);
            chartData.datasets.push({
                label: `20日均线 (MA20)`,
                data: ma20Data,
                borderColor: 'rgb(255, 205, 86)',
                borderDash: [5, 5],
                tension: 0.1,
                fill: false
            });
            
            // 销毁现有图表
            if (stockChart) {
                stockChart.destroy();
            }
            
            // 创建新图表
            stockChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '价格'
                            }
                        }
                    }
                }
            });
        }

        // 生成AI分析建议（从后端API获取）
        function generateAIAnalysis(data, stockCode) {
            // 首先检查响应中是否已包含分析数据
            if (data.analysis) {
                displayAnalysisResult(data.analysis, stockCode);
                return;
            }
            
            // 如果响应中没有分析数据，则从分析API获取
            fetch(`${API_BASE_URL}/stock_analysis?code=${stockCode}&days=${document.getElementById('dataDays').value}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        displayAnalysisResult(result.analysis, stockCode);
                    } else {
                        document.getElementById('aiAnalysis').innerHTML = `<p class="text-danger">获取分析失败: ${result.message}</p>`;
                    }
                })
                .catch(error => {
                    console.error('获取s分析出错:', error);
                    document.getElementById('aiAnalysis').innerHTML = `<p class="text-danger">分析出错: ${error.message}</p>`;
                });
        }
        
        // 显示AI分析结果
        function displayAnalysisResult(analysis, stockCode) {
            const { recommendations, analysis: technicalAnalysis } = analysis;
            
            // 根据建议动作设置样式
            let actionClass = 'text-warning';
            if (recommendations.action === 'BUY') {
                actionClass = 'text-success';
            } else if (recommendations.action === 'SELL') {
                actionClass = 'text-danger';
            }
            
            // 格式化建议理由列表
            const reasonsList = recommendations.reasons.map(reason => `<li>${reason}</li>`).join('');
            
            // 构建HTML
            let analysisHtml = `
                <h6>s代码: ${stockCode}</h6>
                <div class="row">
                    <div class="col-md-6">
                        <h5>技术指标</h5>
                        <table class="table table-sm">
                            <tr>
                                <td>最新收盘价</td>
                                <td>${technicalAnalysis.latest_price.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>价格变动</td>
                                <td class="${technicalAnalysis.price_change >= 0 ? 'text-success' : 'text-danger'}">
                                    ${technicalAnalysis.price_change >= 0 ? '+' : ''}${technicalAnalysis.price_change.toFixed(2)}
                                    (${technicalAnalysis.price_change_percent.toFixed(2)}%)
                                </td>
                            </tr>
                            <tr>
                                <td>5日均价</td>
                                <td>${technicalAnalysis.sma5 ? technicalAnalysis.sma5.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>10日均价</td>
                                <td>${technicalAnalysis.sma10 ? technicalAnalysis.sma10.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>20日均价</td>
                                <td>${technicalAnalysis.sma20 ? technicalAnalysis.sma20.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>30日均价</td>
                                <td>${technicalAnalysis.sma30 ? technicalAnalysis.sma30.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>60日均价</td>
                                <td>${technicalAnalysis.sma60 ? technicalAnalysis.sma60.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>RSI(14)</td>
                                <td>${technicalAnalysis.rsi ? technicalAnalysis.rsi.toFixed(2) : '无数据'}</td>
                            </tr>
                            <tr>
                                <td>成交量</td>
                                <td>${technicalAnalysis.volume ? technicalAnalysis.volume.toLocaleString() : '无数据'}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>交易建议</h5>
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="${actionClass} text-center fw-bold">建议：${getActionText(recommendations.action)}</h6>
                                <p>置信度: <span class="fw-bold">${(recommendations.confidence * 100).toFixed(0)}%</span></p>
                                <p>风险水平: <span class="fw-bold">${getRiskLevelText(recommendations.risk_level)}</span></p>
                                
                                <h6>建议理由:</h6>
                                <ul>${reasonsList}</ul>
                                
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <p>支撑位: <span class="text-success fw-bold">${recommendations.support_level ? recommendations.support_level.toFixed(2) : '无数据'}</span></p>
                                    </div>
                                    <div class="col-6">
                                        <p>阻力位: <span class="text-danger fw-bold">${recommendations.resistance_level ? recommendations.resistance_level.toFixed(2) : '无数据'}</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 免责声明 -->
                <p class="text-muted mt-3"><small>免责声明：以上分析仅供参考，不构成投资建议。投资有风险，入市需谨慎。</small></p>
            `;
            
            document.getElementById('aiAnalysis').innerHTML = analysisHtml;
        }
        
        // 获取操作建议文本
        function getActionText(action) {
            switch(action) {
                case 'BUY': return '买入';
                case 'SELL': return '卖出';
                case 'HOLD': return '观望';
                default: return action;
            }
        }
        
        // 根据推荐文本获取颜色类
        function getActionColorClass(recommendationText) {
            if (recommendationText.includes('强烈推荐') || recommendationText.includes('推荐')) {
                return 'text-success';
            } else if (recommendationText.includes('考虑买入')) {
                return 'text-primary';
            } else if (recommendationText.includes('关注')) {
                return 'text-secondary';
            } else if (recommendationText.includes('不推荐')) {
                return 'text-danger';
            }
            return '';
        }
        
        // 获取风险水平文本
        function getRiskLevelText(level) {
            switch(level) {
                case 'LOW': return '低风险';
                case 'MEDIUM': return '中等风险';
                case 'HIGH': return '高风险';
                default: return level;
            }
        }
        
        // 获取推荐级别文本
        function getRecommendationLevelText(level) {
            switch(parseInt(level)) {
                case 1: return '强烈推荐 (低于60日均线)';
                case 2: return '推荐 (低于30日均线)';
                case 3: return '考虑买入 (低于20日均线)';
                case 4: return '关注 (低于10日均线)';
                case 5: return '轻度关注 (低于5日均线)';
                case 6: return '不推荐 (高于所有均线)';
                default: return '未知';
            }
        }
        
        // 加载存储的s数据
        async function loadStoredStocksData() {
            try {
                const response = await fetch(`${API_BASE_URL}/stored_stocks`);
                const result = await response.json();
                
                if (result.success) {
                    displayStoredStocksData(result);
                } else {
                    document.getElementById('storedDataSummary').innerHTML = `<p class="text-danger">获取数据失败: ${result.message}</p>`;
                    document.getElementById('storedDataTableBody').innerHTML = `<tr><td colspan="9" class="text-center text-danger">获取数据失败</td></tr>`;
                }
            } catch (error) {
                console.error('加载存储s数据出错:', error);
                document.getElementById('storedDataSummary').innerHTML = `<p class="text-danger">加载出错: ${error.message}</p>`;
                document.getElementById('storedDataTableBody').innerHTML = `<tr><td colspan="9" class="text-center text-danger">加载出错</td></tr>`;
            }
        }
        
        // 显示存储的s数据
        function displayStoredStocksData(data) {
            // 显示摘要信息
            const summary = data.summary;
            const summaryHtml = `
                <div class="alert alert-info">
                    <p class="mb-1"><strong>数据摘要:</strong> 共存储了 ${summary.stock_count} 只s的 ${summary.total_records} 条价格记录</p>
                    <p class="mb-0">数据时间范围: ${formatDate(summary.earliest_date)} 至 ${formatDate(summary.latest_date)}</p>
                </div>
            `;
            document.getElementById('storedDataSummary').innerHTML = summaryHtml;
            
            // 显示s数据
            if (data.stocks.length === 0) {
                document.getElementById('storedDataTableBody').innerHTML = `<tr><td colspan="9" class="text-center">暂无数据</td></tr>`;
                return;
            }
            
            let tableHtml = '';
            data.stocks.forEach(stock => {
                const latestData = stock.latest_data;
                
                // 获取涨跌幅并设置样式
                let changePercent = '-';
                let changeClass = '';
                
                if (latestData.change_percent !== null) {
                    changePercent = latestData.change_percent.toFixed(2) + '%';
                    changeClass = latestData.change_percent > 0 ? 'text-success' : 
                                  latestData.change_percent < 0 ? 'text-danger' : '';
                    changePercent = latestData.change_percent > 0 ? '+' + changePercent : changePercent;
                }
                
                tableHtml += `
                    <tr>
                        <td>${formatStockCodeName(stock.code)}</td>
                        <td>${formatDate(latestData.time)}</td>
                        <td>${latestData.close !== null ? latestData.close.toFixed(2) : '-'}</td>
                        <td class="${changeClass}">${changePercent}</td>
                        <td>${latestData.high !== null ? latestData.high.toFixed(2) : '-'}</td>
                        <td>${latestData.low !== null ? latestData.low.toFixed(2) : '-'}</td>
                        <td>${latestData.volume !== null ? latestData.volume.toLocaleString() : '-'}</td>
                        <td>${stock.stats.record_count}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-stock" data-code="${stock.code}">图表</button>
                            <button class="btn btn-sm btn-info view-detail" data-code="${stock.code}">详情</button>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('storedDataTableBody').innerHTML = tableHtml;
            
            // 为"图表"按钮添加点击事件
            document.querySelectorAll('.view-stock').forEach(button => {
                button.addEventListener('click', () => {
                    const stockCode = button.getAttribute('data-code');
                    // 设置下拉框选中该s
                    document.getElementById('stockCode').value = stockCode;
                    // 触发查询
                    document.getElementById('queryData').click();
                    // 滚动到图表位置
                    document.querySelector('.card:has(#stockChart)').scrollIntoView({ behavior: 'smooth' });
                });
            });
            
            // 为"详情"按钮添加点击事件
            document.querySelectorAll('.view-detail').forEach(button => {
                button.addEventListener('click', () => {
                    const stockCode = button.getAttribute('data-code');
                    openStockDetailModal(stockCode);
                });
            });
        }
        
        // 格式化日期显示
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        // 刷新存储的s数据
        document.getElementById('refreshStoredData').addEventListener('click', async () => {
            document.getElementById('storedDataSummary').innerHTML = '<p>刷新中...</p>';
            document.getElementById('storedDataTableBody').innerHTML = '<tr><td colspan="9" class="text-center">刷新中...</td></tr>';
            await loadStoredStocksData();
        });
        
        // 打开s详细数据模态框
        let detailStockChart = null;
        async function openStockDetailModal(stockCode) {
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('stockDetailModal'));
            modal.show();
            
            // 更新标题
            document.getElementById('stockDetailModalLabel').textContent = `s详细数据 - ${stockCode}`;
            
            // 初始化内容
            document.getElementById('stockDetailInfo').innerHTML = '<p>加载中...</p>';
            document.getElementById('stockDetailTableBody').innerHTML = '<tr><td colspan="8" class="text-center">加载中...</td></tr>';
            
            // 销毁之前的图表
            if (detailStockChart) {
                detailStockChart.destroy();
                detailStockChart = null;
            }
            
            try {
                // 获取数据
                const response = await fetch(`${API_BASE_URL}/stock_all_data?code=${stockCode}`);
                const result = await response.json();
                
                if (result.success) {
                    displayStockDetailData(result);
                } else {
                    document.getElementById('stockDetailInfo').innerHTML = `<p class="text-danger">获取数据失败: ${result.message}</p>`;
                    document.getElementById('stockDetailTableBody').innerHTML = `<tr><td colspan="8" class="text-center text-danger">获取数据失败</td></tr>`;
                }
            } catch (error) {
                console.error('获取s详细数据出错:', error);
                document.getElementById('stockDetailInfo').innerHTML = `<p class="text-danger">获取数据出错: ${error.message}</p>`;
                document.getElementById('stockDetailTableBody').innerHTML = `<tr><td colspan="8" class="text-center text-danger">获取数据出错</td></tr>`;
            }
        }
        
        // 显示s详细数据
        function displayStockDetailData(result) {
            const { code, data, info } = result;
            
            // 显示s信息
            let infoHtml = `<div class="alert alert-info">`;
            infoHtml += `<h6>s代码: ${formatStockCodeName(code)}</h6>`;
            
            if (info) {
                infoHtml += `<p class="mb-1">s名称: ${info.name || '-'}</p>`;
                infoHtml += `<p class="mb-1">每手股数: ${info.lot_size || '-'}</p>`;
                infoHtml += `<p class="mb-1">s类型: ${info.stock_type || '-'} / ${info.stock_child_type || '-'}</p>`;
                infoHtml += `<p class="mb-0">上市日期: ${info.listing_date ? formatDate(info.listing_date) : '-'}</p>`;
            } else {
                infoHtml += `<p class="mb-0">没有可用的s基本信息</p>`;
            }
            
            infoHtml += `</div>`;
            document.getElementById('stockDetailInfo').innerHTML = infoHtml;
            
            // 绘制图表
            const closePrices = data.map(item => item.close);
            
            // 计算移动平均线
            const ma5Data = calculateMovingAverage(closePrices, 5);
            const ma10Data = calculateMovingAverage(closePrices, 10);
            const ma20Data = calculateMovingAverage(closePrices, 20);
            const ma30Data = calculateMovingAverage(closePrices, 30);
            const ma60Data = calculateMovingAverage(closePrices, 60);
            
            const chartData = {
                labels: data.map(item => formatDate(item.time)),
                datasets: [
                    {
                        label: `${code} 收盘价`,
                        data: closePrices,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: `MA5`,
                        data: ma5Data,
                        borderColor: 'rgb(255, 159, 64)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: `MA10`,
                        data: ma10Data,
                        borderColor: 'rgb(153, 102, 255)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: `MA20`,
                        data: ma20Data,
                        borderColor: 'rgb(255, 205, 86)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: `MA30`,
                        data: ma30Data,
                        borderColor: 'rgb(54, 162, 235)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: `MA60`,
                        data: ma60Data,
                        borderColor: 'rgb(255, 99, 132)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        fill: false
                    }
                ]
            };
            
            const ctx = document.getElementById('detailStockChart').getContext('2d');
            detailStockChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${code} 历史价格走势`
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '价格'
                            }
                        }
                    }
                }
            });
            
            // 显示表格数据
            if (data.length === 0) {
                document.getElementById('stockDetailTableBody').innerHTML = `<tr><td colspan="8" class="text-center">暂无数据</td></tr>`;
                return;
            }
            
            // 为计算涨跌幅，先按日期排序
            const sortedData = [...data].sort((a, b) => new Date(a.time) - new Date(b.time));
            
            let tableHtml = '';
            sortedData.forEach((item, index) => {
                // 计算涨跌幅
                let changePercent = '-';
                let changeClass = '';
                
                if (index > 0 && item.close !== null && sortedData[index-1].close !== null) {
                    const prevClose = sortedData[index-1].close;
                    const change = item.close - prevClose;
                    const percent = (change / prevClose) * 100;
                    
                    changePercent = percent.toFixed(2) + '%';
                    changeClass = percent > 0 ? 'text-success' : percent < 0 ? 'text-danger' : '';
                    changePercent = percent > 0 ? '+' + changePercent : changePercent;
                }
                
                tableHtml += `
                    <tr>
                        <td>${formatDate(item.time)}</td>
                        <td>${item.open !== null ? item.open.toFixed(2) : '-'}</td>
                        <td>${item.close !== null ? item.close.toFixed(2) : '-'}</td>
                        <td>${item.high !== null ? item.high.toFixed(2) : '-'}</td>
                        <td>${item.low !== null ? item.low.toFixed(2) : '-'}</td>
                        <td>${item.volume !== null ? item.volume.toLocaleString() : '-'}</td>
                        <td>${item.turnover !== null ? item.turnover.toLocaleString() : '-'}</td>
                        <td class="${changeClass}">${changePercent}</td>
                    </tr>
                `;
            });
            
            document.getElementById('stockDetailTableBody').innerHTML = tableHtml;
        }

        // 计算移动平均线
        function calculateMovingAverage(data, period) {
            const result = [];
            
            // 填充前面的 null 值
            for (let i = 0; i < period - 1; i++) {
                result.push(null);
            }
            
            // 计算移动平均
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j];
                }
                result.push(sum / period);
            }
            
            return result;
        }


        // 1. 添加一个新的全局变量用于存储股票名称
        let stockNamesMap = {};

        // 2. 添加一个新的函数用于加载股票名称
        async function loadStockNames() {
            try {
                const response = await fetch(`${API_BASE_URL}/stock_names`);
                const data = await response.json();
                
                if (data.success) {
                    stockNamesMap = data.stock_names || {};
                    console.log("已加载股票名称:", Object.keys(stockNamesMap).length);
                } else {
                    console.error("加载股票名称失败:", data.message);
                }
            } catch (error) {
                console.error("获取股票名称出错:", error);
            }
        }

        // 4. 添加一个辅助函数用于格式化股票代码和名称
        function formatStockCodeName(code) {
            const name = stockNamesMap[code] || '';
            if (name) {
                return `${code} - ${name}`;
            }
            return code;
        }

    </script>
</body>
</html>